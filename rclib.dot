function _exists() {
    local bin=${1}

    if [ -n "${ZSH_VERSION}" ]; then
        local -r _not_found_pattern="not found$"
        if [[ "$(which "${1}" 2> /dev/null)" =~ ${_not_found_pattern} ]]; then
            echo 0
        else
            echo 1
        fi
    else
        which "${1}" 2>&1 > /dev/null
        if [[ 0 != "$?" ]]; then
            echo 0
        else
            echo 1
        fi
    fi
}

if [[ -n "${ZSH_VERSION}" ]]; then
    # Helpful arm-ldd function
    if [[ "1" == "$(_exists patchelf)" ]]; then
        function arm-ldd() { patchelf --print-needed $1 }
    else
        function arm-ldd() { readelf -d $1 | grep "\(NEEDED\)" | sed -r "s/.*\[(.*)\]/\1/" }
    fi
fi

function a2a() {
    adb wait-for-device pull /sys/fs/selinux/policy
    adb logcat -b all -d | audit2allow -p policy
}

function adb_back() {
    adb wait-for-device shell input keyevent 4
}

function adb_logcat() {
    # This is whatever I find useful at the time
    local -a suppress=(
        "LightsService" "PhoneInterfaceManager" "perfetto" "com.ford.vs.clock.ClockService"
        "carwatchdogd" "healthd" "LocationManagerService" "ford.vhal@1.0-CarInputTranslator"
        "Gralloc3" "BestClock" "FastPrintWriter" "ford.hardware.bluetooth.hci@1.0"
        "BatteryStatsService" "BatteryExternalStatsWorker" "VoiceInteractionManager"
        "MediaProvider" "TextServicesManagerService" "TextServicesManagerService" "VvmPkgInstalledRcvr"
        "BufferQueueProducer" "CompositionEngine" "GraphicBufferAllocator" "display" "gralloc" "ion" "ionalloc" "cma" "ColorUtils" "Codec2Client" "FMQ" "Choreographer"
        "ford.vhal@1.0-CANRxMsgSetFilter"
    )
    local suppress_str=""
    for s in ${suppress[@]}; do
        suppress_str+="${s}:S "
    done
    adb logcat ${suppress_str} \
        | rg -v ' D soa.gateway' \
        | rg -i '(\s(E|W)\s|soa|listsort)'
}
